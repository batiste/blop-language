import { mount } from 'blop'


def SimpleComponent(ctx: Component) {
  { children } = ctx
  <div class="simple">children</div>
}

def Card(ctx: Component) {
  { attributes } = ctx
  { title, content, footer } = attributes
  <div class="card">
    <h2>title</h2>
    <p>content</p>
    if footer {
      <footer>footer</footer>
    }
  </div>
}

Button = (ctx: Component) => {
  { attributes, children } = ctx
  { label, variant } = attributes
  className = 'btn-'variant''
  <button class=className>
    = label
    = children
  </button>
}

def Header(ctx: Component) {
  { attributes } = ctx
  { title } = attributes
  <header>
    <h1>title</h1>
  </header>
}

def Content() {
  <main>
    <p>'Main content'</p>
  </main>
}

def Footer() {
  <footer>'Footer content'</footer>
}

def Page(ctx: Component) {
  { attributes } = ctx
  { title } = attributes
  <div class="page">
    <Header title />
    <Content />
    <Footer />
  </div>
}

def Counter(ctx: Component) {
  { attributes } = ctx
  { count, onIncrement } = attributes
  <div class="counter">
    <span>'Count: 'count</span>
    <button on={ click: onIncrement }>'Increment'</button>
  </div>
}

def TestLiteralTypeWidening(ctx: Component): VNode {
  { value as count, setState } = ctx.state('count', 0)
  
  <button on={ click: () => setState(count + 1) }>
    'Increment'
  </button>
}

def List(ctx: Component) {
  { attributes, children } = ctx
  { items } = attributes
  <ul>
    for item in items {
      <li>item</li>
    }
    = children
  </ul>
}

def App(ctx: Component) {
  { attributes } = ctx
  { user } = attributes
  <div class="app">
    <Header title=user.name />
    <Card
      title="Welcome"
      content='Hello, 'user.name'!'
      footer="Thanks for visiting" />
    <Button label="Click me" variant="primary"></Button>
  </div>
}

def CounterDemo(ctx: Component): VNode {
  { value } = ctx.state<number>('count', 0)
  return <div>value</div>
}

// span1 = <span>1 + 'a'</span> // fail correctly
// span2 = <span>'a' + 1</span> // fail correctly
// value = 1
// value + 'a' // should fail but currently doesn't
// 'a' + value // fail correctly

// test builtin functions
clearInterval(1)

def ErrorIcon() {
  <span class="icon error">'❌'</span>
}

def SuccessIcon() {
  <span class="icon success">'✓'</span>
}

def Message(ctx: Component) {
  { attributes } = ctx
  { msgType, text } = attributes
  if msgType == 'error' {
    <div class="error">
      <ErrorIcon />
      = text
    </div>
  } elseif msgType == 'success' {
    <div class="success">
      <SuccessIcon />
      = text
    </div>
  } else {
    <div class="info">text</div>
  }
}

def TableRow(ctx: Component) {
  { attributes } = ctx
  { name, value } = attributes
  <tr>
    <td>name</td>
    <td>value</td>
  </tr>
}

def Table(ctx: Component) {
  { attributes } = ctx
  { rows } = attributes
  <table>
    <thead>
      <tr>
        <th>'Name'</th>
        <th>'Value'</th>
      </tr>
    </thead>
    <tbody>
      for row in rows {
        <TableRow name=row.name value=row.value />
      }
    </tbody>
  </table>
}

def Link(ctx: Component) {
  { attributes } = ctx
  { href, text } = attributes
  <a href>text</a>
}

def Navigation(ctx: Component) {
  { attributes } = ctx
  { links } = attributes
  <nav>
    for link in links {
      // Using component as a function
      = Link({ attributes: { href: link.href, text: link.text }, children: [] })
    }
  </nav>
}

// Component with mixed children types
def Container(ctx: Component) {
  { attributes, children } = ctx
  <div class="container">
    <h2>attributes.title</h2>
    for child in children {
      = child
    }
  </div>
}

test('simple component', () => {
  children = ['Hello', <span>'World'</span>]
  vnode = SimpleComponent({ attributes: {}, children: children })
  expect(vnode.sel).toBe('div')
  expect(vnode.data.attrs['class']).toBe('simple')
  expect(vnode.children[0].text).toBe('Hello')
  expect(vnode.children[1].children[0].text).toBe('World')
})

test('component with attributes', () => {
  vnode = Card({
    attributes: {
      title: 'Test Card',
      content: 'Card content',
      footer: 'Card footer'
    }
  })
  expect(vnode.sel).toBe('div')
  expect(vnode.children[0].sel).toBe('h2')
})

test('arrow function component', () => {
  vnode = Button({ attributes: { label: 'Click', variant: 'primary' }, children: [] })
  expect(vnode.sel).toBe('button')
  expect(vnode.data.attrs['class']).toBe('btn-primary')
})

test('nested components', () => {
  vnode = Page({ attributes: { title: 'Test Page' } })
  expect(vnode.sel).toBe('div')
  expect(vnode.data.attrs['class']).toBe('page')
  // Check that child components are rendered
  expect(vnode.children.length).toBe(3)
})

test('component with counter', () => {
  count = 0
  increment = () => {
    count := count + 1
  }
  vnode = Counter({ attributes: { count, onIncrement: increment } })
  expect(vnode.sel).toBe('div')
  expect(vnode.data.attrs['class']).toBe('counter')
})

test('component with list', () => {
  items = ['Item 1', 'Item 2', 'Item 3']
  vnode = List({ attributes: { items }, children: [] })
  expect(vnode.sel).toBe('ul')
  expect(vnode.children.length).toBe(3)
})

test('composed components', () => {
  user = { name: 'Alice' }
  vnode = App({ attributes: { user } })
  expect(vnode.sel).toBe('div')
  expect(vnode.data.attrs['class']).toBe('app')
})

test('conditional component rendering', () => {
  vnode1 = Message({ attributes: { msgType: 'error', text: 'Error!' } })
  expect(vnode1.sel).toBe('div')
  expect(vnode1.data.attrs['class']).toBe('error')
  
  vnode2 = Message({ attributes: { msgType: 'success', text: 'Success!' } })
  expect(vnode2.sel).toBe('div')
  expect(vnode2.data.attrs['class']).toBe('success')
  
  vnode3 = Message({ attributes: { msgType: 'info', text: 'Info' } })
  expect(vnode3.sel).toBe('div')
  expect(vnode3.data.attrs['class']).toBe('info')
})

test('table with component rows', () => {
  rows = [
    { name: 'First', value: 1 },
    { name: 'Second', value: 2 }
  ]
  vnode = Table({ attributes: { rows } })
  expect(vnode.sel).toBe('table')
  expect(vnode.children[1].sel).toBe('tbody')
})

test('component used as function', () => {
  links = [
    { href: '/home', text: 'Home' },
    { href: '/about', text: 'About' }
  ]
  vnode = Navigation({ attributes: { links } })
  expect(vnode.sel).toBe('nav')
  expect(vnode.children.length).toBe(2)
})

test('container with mixed children', () => {
  child1 = <span>'Child 1'</span>
  child2 = <span>'Child 2'</span>
  vnode = Container({ attributes: { title: 'Mixed' }, children: [child1, child2] })
  expect(vnode.sel).toBe('div')
  expect(vnode.children[0].sel).toBe('h2')
  expect(vnode.children.length >= 2).toBe(true)
})

// Destructuring parameter syntax

def Badge({ attributes }: Component) {
  <span class=attributes.variant>attributes.text</span>
}

def WelcomePanel({ attributes, children }: Component) {
  <div class="welcome">
    <h1>attributes.title</h1>
    = children
  </div>
}

test('destructuring param - attributes only', () => {
  vnode = Badge({ attributes: { variant: 'success', text: 'OK' } })
  expect(vnode.sel).toBe('span')
  expect(vnode.data.attrs['class']).toBe('success')
})

test('destructuring param - attributes and children', () => {
  child = <p>'Hello'</p>
  vnode = WelcomePanel({ attributes: { title: 'Welcome' }, children: [child] })
  expect(vnode.sel).toBe('div')
  expect(vnode.children[0].sel).toBe('h1')
})
